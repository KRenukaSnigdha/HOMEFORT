<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HomeFort AI | Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    background: #f4f7fb;
    color: #1b2430;
}

/* NAVBAR */
header {
    background: white;
    border-bottom: 1px solid #dbe2ea;
    padding: 14px 60px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
}

.brand {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo {
    width: 42px;
    height: 42px;
    border-radius: 12px;
    background: linear-gradient(135deg, #0a2a66, #153e8c);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    font-weight: bold;
    color: white;
    box-shadow: 0px 6px 18px rgba(0,0,0,0.12);
}

.brand h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 800;
    color: #0a2a66;
    letter-spacing: 0.5px;
}

nav {
    display: flex;
    align-items: center;
    gap: 18px;
}

nav a {
    text-decoration: none;
    font-size: 14px;
    color: #2a3646;
    font-weight: 600;
    transition: 0.3s;
    position: relative;
}

nav a:hover {
    color: #0a2a66;
}

.badge {
    position: absolute;
    top: -7px;
    right: -14px;
    background: #d32f2f;
    color: white;
    font-size: 11px;
    font-weight: 800;
    padding: 3px 7px;
    border-radius: 50px;
}

.logout-btn {
    background: #0a2a66;
    color: white;
    padding: 9px 16px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 700;
    text-decoration: none;
    transition: 0.3s;
}

.logout-btn:hover {
    background: #153e8c;
}

/* MAIN WRAPPER */
.wrapper {
    max-width: 1400px;
    margin: 35px auto;
    padding: 0 25px;
}

/* DASHBOARD GRID */
.container {
    display: grid;
    grid-template-columns: 320px 1fr 380px;
    gap: 18px;
}

/* CARD STYLE */
.card-box {
    background: white;
    border: 1px solid #dbe2ea;
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0px 6px 20px rgba(0,0,0,0.06);
}

/* SIDEBAR */
.sidebar h3 {
    margin-top: 0;
    font-size: 16px;
    color: #0a2a66;
    font-weight: 800;
}

.sidebar p {
    font-size: 14px;
    margin: 10px 0;
    color: #3b4a5c;
}

.sidebar p b {
    color: #1b2430;
}

/* MAIN */
.main h2 {
    margin-top: 0;
    font-size: 18px;
    color: #0a2a66;
    font-weight: 900;
}

.stats {
    margin-top: 5px;
    font-size: 14px;
    color: #56657a;
}

/* FILTER BAR */
.filter-box {
    margin: 15px 0 18px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}

select, input {
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid #cbd5e1;
    background: white;
    color: #1b2430;
    font-size: 13px;
    font-weight: 600;
    outline: none;
}

.btn {
    padding: 8px 14px;
    border-radius: 10px;
    border: none;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
}

.btn-primary {
    background: #0a2a66;
    color: white;
}

.btn-primary:hover {
    background: #153e8c;
}

.btn-secondary {
    background: #e5ebf3;
    color: #0a2a66;
}

.btn-secondary:hover {
    background: #d7e0ec;
}

/* TABLE */
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 10px;
}

th, td {
    padding: 10px;
    border-bottom: 1px solid #e5ebf3;
    text-align: left;
}

th {
    background: #f4f7fb;
    font-size: 13px;
    font-weight: 800;
    color: #0a2a66;
}

tbody tr:hover {
    background: rgba(10, 42, 102, 0.08);
    cursor: pointer;
}

/* PAGINATION */
.pagination {
    display: flex;
    justify-content: space-between;
    margin-top: 14px;
    align-items: center;
    font-size: 13px;
    font-weight: 700;
    color: #2a3646;
}

/* ALERTS */
.alerts h2 {
    margin-top: 0;
    font-size: 18px;
    color: #0a2a66;
    font-weight: 900;
}

.alert-card {
    padding: 12px;
    margin-bottom: 12px;
    font-size: 13px;
    border-radius: 12px;
    border-left: 6px solid;
    background: #f9fbff;
    color: #1b2430;
    line-height: 1.5;
    font-weight: 600;
}

.alert-empty {
    color: #66758a;
    font-size: 14px;
    margin-top: 10px;
}

/* SEVERITY COLORS */
.sev-low { border-left-color: #2e7d32; }
.sev-medium { border-left-color: #ff9800; }
.sev-high { border-left-color: #d32f2f; }
.sev-critical {
    border-left-color: #7b0000;
    background: #fff1f1;
    font-weight: 800;
}

/* CHARTS - STACKED */
.chart-container {
    margin-top: 22px;
    background: white;
    border-radius: 14px;
    padding: 16px;
    border: 1px solid #dbe2ea;
}

/* POPUP MODAL */
.modal {
    display: none;
    position: fixed;
    z-index: 100;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.55);
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    width: 520px;
    max-width: 95%;
    border-radius: 16px;
    padding: 22px;
    box-shadow: 0px 12px 30px rgba(0,0,0,0.2);
}

.modal-content h3 {
    margin-top: 0;
    color: #0a2a66;
    font-size: 18px;
}

.modal-content p {
    font-size: 14px;
    margin: 8px 0;
    color: #2a3646;
}

.close-btn {
    float: right;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    color: #0a2a66;
}

/* RESPONSIVE */
@media(max-width: 1100px) {
    .container {
        grid-template-columns: 1fr;
    }
}
</style>
</head>

<body>

<header>
    <div class="brand">
        <div class="logo">ðŸ›¡</div>
        <h2>HomeFort</h2>
    </div>

    <nav>
        <a href="/">Home</a>

        <a href="/dashboard">
            Dashboard
            <span id="alertBadge" class="badge" style="display:none;">0</span>
        </a>

        <a href="/login" class="logout-btn">Log Out</a>
    </nav>
</header>

<div class="wrapper">
    <div class="container">

        <!-- SIDEBAR -->
        <div class="sidebar card-box">
            <h3>Threat Intelligence</h3>
            <p><b>IP:</b> {{ threat_info.ip }}</p>
            <p><b>Abuse Score:</b> {{ threat_info.abuseConfidenceScore }}</p>
            <p><b>Country:</b> {{ threat_info.countryCode }}</p>
            <p><b>Usage:</b> {{ threat_info.usageType }}</p>
            <p><b>Domain:</b> {{ threat_info.domain }}</p>
            <p><b>Total Reports:</b> {{ threat_info.totalReports }}</p>
        </div>

        <!-- MAIN -->
        <div class="main card-box">
            <h2>Live Traffic Monitor</h2>
            <p class="stats">
                Total packets captured: <span id="totalPackets">0</span>
            </p>

            <!-- FILTERS -->
            <div class="filter-box">
                <select id="protoFilter">
                    <option value="ALL">ALL Protocols</option>
                    <option value="TCP">TCP</option>
                    <option value="UDP">UDP</option>
                    <option value="ICMP">ICMP</option>
                </select>

                <input type="text" id="srcFilter" placeholder="Filter Src IP">
                <input type="text" id="dstFilter" placeholder="Filter Dst IP">
                <input type="text" id="portFilter" placeholder="Filter Port">

                <select id="sortFilter">
                    <option value="time">Sort: Latest</option>
                    <option value="length">Sort: Packet Length</option>
                </select>

                <button class="btn btn-primary" id="pauseBtn">Pause</button>
                <button class="btn btn-secondary" id="exportBtn">Export CSV</button>
            </div>

            <!-- TABLE -->
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Time</th>
                        <th>Src IP</th>
                        <th>Src Port</th>
                        <th>Dst IP</th>
                        <th>Dst Port</th>
                        <th>Protocol</th>
                        <th>Packet Length</th>
                    </tr>
                </thead>
                <tbody id="trafficTable"></tbody>
            </table>

            <!-- PAGINATION -->
            <div class="pagination">
                <button class="btn btn-secondary" id="prevBtn">Prev</button>
                <span>Page: <span id="pageNumber">1</span></span>
                <button class="btn btn-secondary" id="nextBtn">Next</button>
            </div>

            <!-- CHARTS STACKED -->
            <div class="chart-container">
                <canvas id="packetChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="protocolChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="timeChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="severityChart"></canvas>
            </div>
        </div>

        <!-- ALERTS -->
        <div class="alerts card-box">
            <h2>Security Alerts</h2>
            <div id="alertsContainer">
                <div class="alert-empty">Loading alerts...</div>
            </div>
        </div>

    </div>
</div>

<!-- POPUP MODAL -->
<div class="modal" id="packetModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">âœ–</span>
        <h3>Packet Details</h3>
        <div id="modalData"></div>
    </div>
</div>

<!-- ALERT SOUND -->
<audio id="alertSound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
let packetChart, protocolChart, timeChart, severityChart;
let isPaused = false;
let lastAlertCount = 0;

let currentPage = 1;
const rowsPerPage = 10;

document.getElementById("pauseBtn").addEventListener("click", () => {
    isPaused = !isPaused;
    document.getElementById("pauseBtn").textContent = isPaused ? "Resume" : "Pause";
});

document.getElementById("prevBtn").addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        fetchData();
    }
});

document.getElementById("nextBtn").addEventListener("click", () => {
    currentPage++;
    fetchData();
});

function closeModal() {
    document.getElementById("packetModal").style.display = "none";
}

function showModal(packet) {
    const modal = document.getElementById("packetModal");
    const modalData = document.getElementById("modalData");

    modalData.innerHTML = `
        <p><b>Timestamp:</b> ${packet.timestamp}</p>
        <p><b>Source IP:</b> ${packet.src_ip}</p>
        <p><b>Source Port:</b> ${packet.src_port}</p>
        <p><b>Destination IP:</b> ${packet.dst_ip}</p>
        <p><b>Destination Port:</b> ${packet.dst_port}</p>
        <p><b>Protocol:</b> ${packet.protocol}</p>
        <p><b>Packet Length:</b> ${packet.packet_length}</p>
    `;

    modal.style.display = "flex";
}

function getSeverityClass(alertText) {
    alertText = alertText.toLowerCase();
    if (alertText.includes("auto-blocked")) return "sev-critical";
    if (alertText.includes("high")) return "sev-high";
    if (alertText.includes("suspicious")) return "sev-medium";
    return "sev-low";
}

function detectSeverity(alertText) {
    alertText = alertText.toLowerCase();
    if (alertText.includes("auto-blocked")) return "Critical";
    if (alertText.includes("high")) return "High";
    if (alertText.includes("suspicious")) return "Medium";
    return "Low";
}

function exportCSV(rows) {
    let csv = "timestamp,src_ip,src_port,dst_ip,dst_port,protocol,packet_length\n";
    rows.forEach(r => {
        csv += `${r.timestamp},${r.src_ip},${r.src_port},${r.dst_ip},${r.dst_port},${r.protocol},${r.packet_length}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "traffic_export.csv";
    a.click();

    URL.revokeObjectURL(url);
}

document.getElementById("exportBtn").addEventListener("click", async () => {
    const res = await fetch("/api/data");
    const data = await res.json();
    exportCSV(data.packets);
});

function updateCharts(packets, alerts) {

    // 1) PACKET LENGTH CHART
    const lengths = packets.map(p => p.packet_length);
    if (!packetChart) {
        packetChart = new Chart(document.getElementById("packetChart"), {
            type: "line",
            data: {
                labels: lengths.map((_, i) => i + 1),
                datasets: [{
                    label: "Packet Length",
                    data: lengths,
                    borderWidth: 2,
                    tension: 0.3
                }]
            },
            options: { responsive: true, animation: false }
        });
    } else {
        packetChart.data.labels = lengths.map((_, i) => i + 1);
        packetChart.data.datasets[0].data = lengths;
        packetChart.update();
    }

    // 2) PROTOCOL PIE CHART
    const protoCounts = { TCP: 0, UDP: 0, ICMP: 0 };
    packets.forEach(p => {
        if (protoCounts[p.protocol] !== undefined) protoCounts[p.protocol]++;
    });

    if (!protocolChart) {
        protocolChart = new Chart(document.getElementById("protocolChart"), {
            type: "pie",
            data: {
                labels: Object.keys(protoCounts),
                datasets: [{
                    label: "Protocol Distribution",
                    data: Object.values(protoCounts)
                }]
            },
            options: { responsive: true, animation: false }
        });
    } else {
        protocolChart.data.datasets[0].data = Object.values(protoCounts);
        protocolChart.update();
    }

    // 3) PACKETS PER TIME (BAR)
    const timeLabels = packets.map(p => p.timestamp);
    if (!timeChart) {
        timeChart = new Chart(document.getElementById("timeChart"), {
            type: "bar",
            data: {
                labels: timeLabels,
                datasets: [{
                    label: "Packets per Timestamp",
                    data: timeLabels.map(() => 1)
                }]
            },
            options: { responsive: true, animation: false }
        });
    } else {
        timeChart.data.labels = timeLabels;
        timeChart.data.datasets[0].data = timeLabels.map(() => 1);
        timeChart.update();
    }

    // 4) ALERT SEVERITY DOUGHNUT
    const severityCounts = { Low: 0, Medium: 0, High: 0, Critical: 0 };
    alerts.forEach(a => {
        const sev = detectSeverity(a.raw);
        severityCounts[sev]++;
    });

    if (!severityChart) {
        severityChart = new Chart(document.getElementById("severityChart"), {
            type: "doughnut",
            data: {
                labels: Object.keys(severityCounts),
                datasets: [{
                    label: "Alert Severity",
                    data: Object.values(severityCounts)
                }]
            },
            options: { responsive: true, animation: false }
        });
    } else {
        severityChart.data.datasets[0].data = Object.values(severityCounts);
        severityChart.update();
    }
}

async function fetchData() {
    if (isPaused) return;

    try {
        const res = await fetch("/api/data");
        const data = await res.json();

        document.getElementById("totalPackets").textContent = data.total_packets;

        // ALERT BADGE + SOUND
        const badge = document.getElementById("alertBadge");
        if (data.alerts.length > 0) {
            badge.style.display = "inline-block";
            badge.textContent = data.alerts.length;
        } else {
            badge.style.display = "none";
        }

        if (data.alerts.length > lastAlertCount) {
            document.getElementById("alertSound").play();
        }
        lastAlertCount = data.alerts.length;

        // FILTER VALUES
        const protoFilter = document.getElementById("protoFilter").value;
        const srcFilter = document.getElementById("srcFilter").value.trim();
        const dstFilter = document.getElementById("dstFilter").value.trim();
        const portFilter = document.getElementById("portFilter").value.trim();
        const sortFilter = document.getElementById("sortFilter").value;

        let filteredPackets = data.packets;

        if (protoFilter !== "ALL") {
            filteredPackets = filteredPackets.filter(p => p.protocol === protoFilter);
        }

        if (srcFilter.length > 0) {
            filteredPackets = filteredPackets.filter(p => p.src_ip.includes(srcFilter));
        }

        if (dstFilter.length > 0) {
            filteredPackets = filteredPackets.filter(p => p.dst_ip.includes(dstFilter));
        }

        if (portFilter.length > 0) {
            filteredPackets = filteredPackets.filter(p =>
                String(p.src_port).includes(portFilter) ||
                String(p.dst_port).includes(portFilter)
            );
        }

        if (sortFilter === "length") {
            filteredPackets.sort((a, b) => b.packet_length - a.packet_length);
        }

        // PAGINATION
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedPackets = filteredPackets.slice(start, end);

        document.getElementById("pageNumber").textContent = currentPage;

        // TABLE
        const tbody = document.getElementById("trafficTable");
        tbody.innerHTML = "";

        paginatedPackets.forEach((p, i) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${start + i + 1}</td>
                <td>${p.timestamp}</td>
                <td>${p.src_ip}</td>
                <td>${p.src_port ?? "-"}</td>
                <td>${p.dst_ip}</td>
                <td>${p.dst_port ?? "-"}</td>
                <td>${p.protocol}</td>
                <td>${p.packet_length}</td>
            `;
            row.addEventListener("click", () => showModal(p));
            tbody.appendChild(row);
        });

        // ALERTS (SHOW ONLY 10)
        const alertsDiv = document.getElementById("alertsContainer");
        alertsDiv.innerHTML = "";

        const latestAlerts = data.alerts.slice(0, 10);

        if (latestAlerts.length === 0) {
            alertsDiv.innerHTML = `<div class="alert-empty">No suspicious activity detected.</div>`;
        } else {
            latestAlerts.forEach(a => {
                const sevClass = getSeverityClass(a.raw);
                alertsDiv.insertAdjacentHTML("beforeend", `
                    <div class="alert-card ${sevClass}">
                        ${a.raw}
                    </div>
                `);
            });
        }

        // UPDATE CHARTS USING FULL FILTERED PACKETS
        updateCharts(filteredPackets, latestAlerts);

    } catch (e) {
        console.error("IDS fetch error:", e);
    }
}

fetchData();
setInterval(fetchData, 3000);
</script>

</body>
</html>
