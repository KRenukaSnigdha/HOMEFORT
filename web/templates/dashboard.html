<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeFort Dashboard</title>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet Script -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f5f7fb;
        }

        header {
            background: #0a2a66;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        header .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header .logo {
            font-size: 24px;
        }

        header nav a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: bold;
            position: relative;
        }

        .badge {
            background: red;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 50%;
            position: absolute;
            top: -8px;
            right: -10px;
        }

        .logout-btn {
            background: crimson;
            padding: 8px 14px;
            border-radius: 6px;
        }

        .wrapper {
            padding: 20px;
        }

        .container {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            gap: 15px;
        }

        .card-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .main h2 {
            margin-top: 0;
            color: #0a2a66;
        }

        .stats {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .filter-box {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        select, input {
            padding: 8px;
            border: 1px solid #dbe2ea;
            border-radius: 6px;
            outline: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table th {
            background: #0a2a66;
            color: white;
            padding: 10px;
            font-size: 14px;
        }

        table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
            cursor: pointer;
        }

        table tr:hover {
            background: #f0f4ff;
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #0a2a66;
            color: white;
        }

        .btn-secondary {
            background: #dbe2ea;
            color: #0a2a66;
        }

        .pagination {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 12px;
            align-items: center;
        }

        .chart-container {
            margin-top: 15px;
            height: 400px;
            display: flex;
           justify-content: center;
           align-items: center;

        }

        .map-box {
            margin-top: 18px;
            border-radius: 10px;
            overflow: hidden;
        }

        #attackMap {
            width: 100%;
            height: 350px;
        }

        .alerts h2 {
            margin-top: 0;
            color: #0a2a66;
        }

        .alert-card {
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 8px;
            font-size: 13px;
            border-left: 6px solid gray;
            background: #f8f9fb;
        }

        .sev-safe {
            border-left-color: #1bbf4b;
        }

        .sev-suspicious {
            border-left-color: orange;
        }

        .sev-malicious {
            border-left-color: crimson;
        }

        .sev-blocked {
            border-left-color: black;
            background: #f1f1f1;
        }

        .alert-meta {
            font-size: 12px;
            margin-top: 6px;
            color: #333;
        }

        .alert-empty {
            color: gray;
            font-size: 14px;
            text-align: center;
            padding: 15px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
        }

        .close-btn {
            float: right;
            cursor: pointer;
            font-weight: bold;
            color: crimson;
        }
    </style>
</head>

<body>

<header>
    <div class="brand">
        <div class="logo">üõ°</div>
        <h2>HomeFort</h2>
    </div>

    <nav>
        <a href="/">Home</a>

        <a href="/dashboard">
            Dashboard
            <span id="alertBadge" class="badge" style="display:none;">0</span>
        </a>

        <a href="/login" class="logout-btn">Log Out</a>
    </nav>
</header>

<div class="wrapper">
    <div class="container">

        <!-- SIDEBAR -->
        <div class="sidebar card-box">
            <h3>Threat Intelligence Lookup</h3>

            <input type="text" id="ipLookupInput" placeholder="Enter IP (ex: 89.222.98.34)"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #dbe2ea; margin-top:10px;">

            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="lookupThreatIntel()">
                Check IP Reputation
            </button>

            <div id="intelBox" style="margin-top:15px; font-size:14px; color:#1b2a4a;">
                <p style="font-size:13px;color:#56657a;">
                    Enter an IP address to fetch AbuseIPDB + VirusTotal reputation data and Geo-location correlation.
                </p>
            </div>

            <hr style="border:0; border-top:1px solid #dbe2ea; margin:16px 0;">

            <h3>Geo-Location Correlation</h3>
            <p style="font-size:13px;color:#56657a;">
                GeoLite2 maps suspicious source IPs to countries/cities, helping visualize attack origin distribution.
            </p>
        </div>

        <!-- MAIN -->
        <div class="main card-box">
            <h2>Live Traffic Monitor</h2>
            <p class="stats">
                Total packets captured: <span id="totalPackets">0</span>
            </p>

            <!-- FILTERS -->
            <div class="filter-box">
                <select id="protoFilter">
                    <option value="ALL">ALL Protocols</option>
                    <option value="TCP">TCP</option>
                    <option value="UDP">UDP</option>
                    <option value="ICMP">ICMP</option>
                </select>

                <input type="text" id="srcFilter" placeholder="Filter Src IP">
                <input type="text" id="dstFilter" placeholder="Filter Dst IP">
                <input type="text" id="portFilter" placeholder="Filter Port">

                <select id="sortFilter">
                    <option value="time">Sort: Latest</option>
                    <option value="length">Sort: Packet Length</option>
                </select>

                <button class="btn btn-primary" id="pauseBtn">Pause</button>
                <button class="btn btn-secondary" id="exportBtn">Export CSV</button>
            </div>

            <!-- TABLE -->
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Time</th>
                        <th>Src IP</th>
                        <th>Src Port</th>
                        <th>Dst IP</th>
                        <th>Dst Port</th>
                        <th>Protocol</th>
                        <th>Packet Length</th>
                    </tr>
                </thead>
                <tbody id="trafficTable"></tbody>
            </table>

            <!-- PAGINATION -->
            <div class="pagination">
                <button class="btn btn-secondary" id="prevBtn">Prev</button>
                <span>Page: <span id="pageNumber">1</span></span>
                <button class="btn btn-secondary" id="nextBtn">Next</button>
            </div>

            <!-- CHARTS -->
            <div class="chart-container">
                <canvas id="packetChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="protocolChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="timeChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="severityChart"></canvas>
            </div>

            <!-- MAP -->
            <div class="map-box">
                <h2 style="margin-top:0;font-size:18px;color:#0a2a66;font-weight:900;">
                    Geo-Threat Map (GeoLite2)
                </h2>
                <div id="attackMap"></div>
            </div>

            <!-- COUNTRY ATTACK CHART -->
            <div class="chart-container">
                <canvas id="countryChart"></canvas>
            </div>
        </div>

        <!-- ALERTS -->
        <div class="alerts card-box">
            <h2>Security Alerts</h2>
            <div id="alertsContainer">
                <div class="alert-empty">Loading alerts...</div>
            </div>
        </div>

    </div>
</div>

<!-- POPUP MODAL -->
<div class="modal" id="packetModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">‚úñ</span>
        <h3>Packet Details</h3>
        <div id="modalData"></div>
    </div>
</div>

<!-- ALERT SOUND -->
<audio id="alertSound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
let packetChart, protocolChart, timeChart, severityChart, countryChart;
let isPaused = false;
let lastAlertCount = 0;
let lastAlerts = [];
let currentPage = 1;
const rowsPerPage = 10;

let map;
let markersLayer;

document.getElementById("pauseBtn").addEventListener("click", () => {
    isPaused = !isPaused;
    document.getElementById("pauseBtn").textContent = isPaused ? "Resume" : "Pause";
});

document.getElementById("prevBtn").addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        fetchData();
    }
});

document.getElementById("nextBtn").addEventListener("click", () => {
    currentPage++;
    fetchData();
});

function closeModal() {
    document.getElementById("packetModal").style.display = "none";
}

function showModal(packet) {
    const modal = document.getElementById("packetModal");
    const modalData = document.getElementById("modalData");

    modalData.innerHTML = `
        <p><b>Timestamp:</b> ${packet.timestamp}</p>
        <p><b>Source IP:</b> ${packet.src_ip}</p>
        <p><b>Source Port:</b> ${packet.src_port}</p>
        <p><b>Destination IP:</b> ${packet.dst_ip}</p>
        <p><b>Destination Port:</b> ${packet.dst_port}</p>
        <p><b>Protocol:</b> ${packet.protocol}</p>
        <p><b>Packet Length:</b> ${packet.packet_length}</p>
    `;

    modal.style.display = "flex";
}

function getDecisionClass(decision, blocked) {
    if (blocked === true) return "sev-blocked";
    if (!decision) return "sev-safe";

    decision = decision.toUpperCase();

    if (decision === "MALICIOUS") return "sev-malicious";
    if (decision === "SUSPICIOUS") return "sev-suspicious";
    return "sev-safe";
}

function decisionToSeverity(decision, blocked) {
    if (blocked === true) return "Blocked";
    if (!decision) return "Safe";

    decision = decision.toUpperCase();

    if (decision === "MALICIOUS") return "Malicious";
    if (decision === "SUSPICIOUS") return "Suspicious";
    return "Safe";
}

function exportCSV(rows) {
    let csv = "timestamp,src_ip,src_port,dst_ip,dst_port,protocol,packet_length\n";
    rows.forEach(r => {
        csv += `${r.timestamp},${r.src_ip},${r.src_port},${r.dst_ip},${r.dst_port},${r.protocol},${r.packet_length}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "traffic_export.csv";
    a.click();

    URL.revokeObjectURL(url);
}

document.getElementById("exportBtn").addEventListener("click", async () => {
    const res = await fetch("/api/data");
    const data = await res.json();
    exportCSV(data.packets);
});


// ---------------- THREAT INTEL LOOKUP ----------------
async function lookupThreatIntel() {
    const ip = document.getElementById("ipLookupInput").value.trim();
    const intelBox = document.getElementById("intelBox");

    if (!ip) {
        intelBox.innerHTML = `<p style="color:red;"><b>Error:</b> Please enter an IP address.</p>`;
        return;
    }

    intelBox.innerHTML = `<p>‚è≥ Fetching threat intelligence for <b>${ip}</b>...</p>`;

    try {
        const res = await fetch("/api/threat-intel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ip: ip })
        });

        const data = await res.json();

        if (data.error) {
            intelBox.innerHTML = `<p style="color:red;"><b>Error:</b> ${data.error}</p>`;
            return;
        }

        const abuse = data.abuseipdb || {};
        const geo = data.geo_location || {};
        const vt = data.virustotal || {};

        intelBox.innerHTML = `
            <h4 style="margin-bottom:10px;">Threat Report</h4>

            <p><b>IP:</b> ${data.ip}</p>
            <p><b>Decision:</b> <span style="color:#0a2a66;font-weight:900;">${data.decision}</span></p>
            <p><b>Final Hybrid Score:</b> ${data.final_score}</p>
            <p><b>Reputation Score:</b> ${data.reputation_score}</p>

            <hr style="border:0; border-top:1px solid #dbe2ea; margin:12px 0;">

            <h4 style="margin-bottom:8px;">AbuseIPDB</h4>
            <p><b>Abuse Score:</b> ${abuse.abuseConfidenceScore ?? "-"}</p>
            <p><b>Country:</b> ${abuse.countryCode ?? "-"}</p>
            <p><b>Usage Type:</b> ${abuse.usageType ?? "-"}</p>
            <p><b>Domain:</b> ${abuse.domain ?? "-"}</p>
            <p><b>Total Reports:</b> ${abuse.totalReports ?? "-"}</p>

            <hr style="border:0; border-top:1px solid #dbe2ea; margin:12px 0;">

            <h4 style="margin-bottom:8px;">Geo Location</h4>
            <p><b>Country:</b> ${geo.country ?? "-"}</p>
            <p><b>City:</b> ${geo.city ?? "-"}</p>
            <p><b>Latitude:</b> ${geo.latitude ?? "-"}</p>
            <p><b>Longitude:</b> ${geo.longitude ?? "-"}</p>

            <hr style="border:0; border-top:1px solid #dbe2ea; margin:12px 0;">

            <h4 style="margin-bottom:8px;">VirusTotal</h4>
            <p><b>Malicious:</b> ${vt.malicious ?? "-"}</p>
            <p><b>Suspicious:</b> ${vt.suspicious ?? "-"}</p>
            <p><b>Harmless:</b> ${vt.harmless ?? "-"}</p>
            <p><b>Undetected:</b> ${vt.undetected ?? "-"}</p>
        `;

    } catch (err) {
        intelBox.innerHTML = `<p style="color:red;"><b>Error:</b> Threat intel fetch failed.</p>`;
        console.error(err);
    }
}


// ---------------- MAP INIT ----------------
function initMap() {
    map = L.map("attackMap").setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    markersLayer = L.layerGroup().addTo(map);
}


// ---------------- UPDATE GEO MAP + COUNTRY CHART ----------------
async function fetchGeoThreats() {
    try {
        const res = await fetch("/api/geo-threats");
        const geoData = await res.json();

        markersLayer.clearLayers();

        const countryCounts = {};

        geoData.forEach(entry => {
            if (entry.latitude && entry.longitude) {
                const popupText = `
                    <b>IP:</b> ${entry.ip}<br>
                    <b>Country:</b> ${entry.country}<br>
                    <b>City:</b> ${entry.city}<br>
                    <b>Hits:</b> ${entry.hits}<br>
                    <b>Risk Score:</b> ${entry.risk_score}
                `;

                L.marker([entry.latitude, entry.longitude])
                    .addTo(markersLayer)
                    .bindPopup(popupText);
            }

            if (entry.country) {
                countryCounts[entry.country] = (countryCounts[entry.country] || 0) + entry.hits;
            }
        });

        const countries = Object.keys(countryCounts);
        const counts = Object.values(countryCounts);

        if (!countryChart) {
            countryChart = new Chart(document.getElementById("countryChart"), {
                type: "bar",
                data: {
                    labels: countries,
                    datasets: [{
                        label: "Attack Hits by Country",
                        data: counts,
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, animation: false }
            });
        } else {
            countryChart.data.labels = countries;
            countryChart.data.datasets[0].data = counts;
            countryChart.update();
        }

    } catch (err) {
        console.error("Geo Threat Fetch Error:", err);
    }
}


// ---------------- UPDATE CHARTS ----------------
function updateCharts(packets, alerts) {

    const lengths = packets.map(p => Number(p.packet_length) || 0);

    if (!packetChart) {
        packetChart = new Chart(document.getElementById("packetChart"), {
            type: "line",
            data: {
                labels: lengths.map((_, i) => i + 1),
                datasets: [{
                    label: "Packet Length",
                    data: lengths,
                    borderWidth: 2,
                    tension: 0.3
                }]
            },
            options: { responsive: true, animation: false }
        });
    } else {
        packetChart.data.labels = lengths.map((_, i) => i + 1);
        packetChart.data.datasets[0].data = lengths;
        packetChart.update();
    }

    const protoCounts = { TCP: 0, UDP: 0, ICMP: 0 };
    packets.forEach(p => {
        if (protoCounts[p.protocol] !== undefined) protoCounts[p.protocol]++;
    });

    if (!protocolChart) {
        protocolChart = new Chart(document.getElementById("protocolChart"), {
            type: "pie",
            data: {
                labels: Object.keys(protoCounts),
                datasets: [{
                    label: "Protocol Distribution",
                    data: Object.values(protoCounts)
                }]
            },
            options: { responsive: true, animation: false }
        });
    } else {
        protocolChart.data.datasets[0].data = Object.values(protoCounts);
        protocolChart.update();
    }

    const timeLabels = packets.map(p => p.timestamp);

    if (!timeChart) {
        timeChart = new Chart(document.getElementById("timeChart"), {
            type: "bar",
            data: {
                labels: timeLabels,
                datasets: [{
                    label: "Packets per Timestamp",
                    data: timeLabels.map(() => 1)
                }]
            },
            options: { responsive: true, animation: false }
        });
    } else {
        timeChart.data.labels = timeLabels;
        timeChart.data.datasets[0].data = timeLabels.map(() => 1);
        timeChart.update();
    }

    const severityCounts = { Safe: 0, Suspicious: 0, Malicious: 0, Blocked: 0 };

    alerts.forEach(a => {
        const sev = decisionToSeverity(a.decision, a.blocked);
        if (severityCounts[sev] !== undefined) {
            severityCounts[sev]++;
        }
    });

    if (!severityChart) {
        severityChart = new Chart(document.getElementById("severityChart"), {
            type: "doughnut",
            data: {
                labels: Object.keys(severityCounts),
                datasets: [{
                    label: "Hybrid Severity Distribution",
                    data: Object.values(severityCounts)
                }]
            },
            options: { responsive: true, animation: false }
        });
    } else {
        severityChart.data.datasets[0].data = Object.values(severityCounts);
        severityChart.update();
    }
}


// ---------------- MAIN FETCH DATA ----------------
async function fetchData() {
    if (isPaused) return;

    try {
        const res = await fetch("/api/data");
        const data = await res.json();

        document.getElementById("totalPackets").textContent = data.total_packets;

        const badge = document.getElementById("alertBadge");
        if (data.alerts.length > 0) {
            badge.style.display = "inline-block";
            badge.textContent = data.alerts.length;
        } else {
            badge.style.display = "none";
        }

        if (data.alerts.length > lastAlertCount) {
            document.getElementById("alertSound").play();
        }
        lastAlertCount = data.alerts.length;

        const protoFilter = document.getElementById("protoFilter").value;
        const srcFilter = document.getElementById("srcFilter").value.trim();
        const dstFilter = document.getElementById("dstFilter").value.trim();
        const portFilter = document.getElementById("portFilter").value.trim();
        const sortFilter = document.getElementById("sortFilter").value;

        let filteredPackets = data.packets;

        if (protoFilter !== "ALL") {
            filteredPackets = filteredPackets.filter(p => p.protocol === protoFilter);
        }

        if (srcFilter.length > 0) {
            filteredPackets = filteredPackets.filter(p => p.src_ip.includes(srcFilter));
        }

        if (dstFilter.length > 0) {
            filteredPackets = filteredPackets.filter(p => p.dst_ip.includes(dstFilter));
        }

        if (portFilter.length > 0) {
            filteredPackets = filteredPackets.filter(p =>
                String(p.src_port).includes(portFilter) ||
                String(p.dst_port).includes(portFilter)
            );
        }

        if (sortFilter === "length") {
            filteredPackets.sort((a, b) => Number(b.packet_length) - Number(a.packet_length));
        }

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedPackets = filteredPackets.slice(start, end);

        document.getElementById("pageNumber").textContent = currentPage;

        const tbody = document.getElementById("trafficTable");
        tbody.innerHTML = "";

        paginatedPackets.forEach((p, i) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${start + i + 1}</td>
                <td>${p.timestamp}</td>
                <td>${p.src_ip}</td>
                <td>${p.src_port ?? "-"}</td>
                <td>${p.dst_ip}</td>
                <td>${p.dst_port ?? "-"}</td>
                <td>${p.protocol}</td>
                <td>${p.packet_length}</td>
            `;
            row.addEventListener("click", () => showModal(p));
            tbody.appendChild(row);
        });

        const alertsDiv = document.getElementById("alertsContainer");
        alertsDiv.innerHTML = "";

        const latestAlerts = data.alerts.slice(1, 11);

        function alertSignature(alert) {
            return `${alert.src_ip || ""}|${alert.dst_ip || ""}|${alert.reason || ""}`;
        }

        function alertsChanged(newAlerts, oldAlerts) {
            if (newAlerts.length !== oldAlerts.length) return true;
            for (let i = 0; i < newAlerts.length; i++) {
                if (alertSignature(newAlerts[i]) !== alertSignature(oldAlerts[i])) {
                    return true;
                }
            }
            return false;
        }

        if (alertsChanged(latestAlerts, lastAlerts)) {
            document.getElementById("alertSound").play();
        }

        lastAlerts = latestAlerts;

        if (latestAlerts.length === 0) {
            alertsDiv.innerHTML = `<div class="alert-empty">No suspicious activity detected.</div>`;
        } else {
            latestAlerts.forEach(a => {
                const sevClass = getDecisionClass(a.decision, a.blocked);

                alertsDiv.insertAdjacentHTML("beforeend", `
                    <div class="alert-card ${sevClass}">
                        <div>
                            <b>${a.decision || "SAFE"}</b>
                            ${a.blocked ? " | üö´ <b>AUTO-BLOCKED</b>" : ""}
                        </div>

                        <div style="margin-top:6px;">
                            <b>Src:</b> ${a.src_ip || "-"} |
                            <b>Dst:</b> ${a.dst_ip || "-"} |
                            <b>Protocol:</b> ${a.protocol || "-"} |
                            <b>Port:</b> ${a.dst_port || "-"}
                        </div>

                        <div class="alert-meta">
                            <b>Final Score:</b> ${a.final_score ?? "-"} <br>
                            <b>ML Score:</b> ${a.ml_score ?? "-"} |
                            <b>Rule Score:</b> ${a.rule_score ?? "-"} |
                            <b>Reputation Score:</b> ${a.reputation_score ?? "-"} <br>
                            <b>Reason:</b> ${a.reason ?? "N/A"}
                        </div>
                    </div>
                `);
            });
        }

        updateCharts(filteredPackets, latestAlerts);

    } catch (e) {
        console.error("IDS fetch error:", e);
    }
}


// ---------------- INIT ----------------
initMap();
fetchData();
fetchGeoThreats();

setInterval(fetchData, 3000);
setInterval(fetchGeoThreats, 6000);
</script>

</body>
</html>
